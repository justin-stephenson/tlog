name: Coverity scan
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  coverity:
    runs-on: ubuntu-latest
    container: fedora:latest
    env:
      TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
    steps:   
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download Coverity Build Tool
      run: |
        set -ex

        curl \
          --data "token=$TOKEN&project=justin-stephenson%2Ftlog" \
          -o covscan.tar.gz \
          https://scan.coverity.com/download/linux64
        mkdir covscan
        tar -xzf covscan.tar.gz --strip 1 -C covscan
        rm covscan.tar.gz

    - name: Install dependencies
      run: |
       dnf -y install autoconf automake make libtool \
       systemd-devel json-c-devel libcurl-devel libutempter-devel

    - name: Configure
      run: autoreconf -if && ./configure

    - name: Build with cov-build
      run: |
        export PATH="$(pwd)/covscan/bin:$PATH"
        cov-build --dir cov-int make

    - name: Print logs
      run: |
        cat cov-int/build-log.txt

    - name: Submit the result to Coverity Scan
      run: |
        tar -czvf build.tgz cov-int
        curl \
          --form project=justin-stephenson/tlog \
          --form token=$TOKEN \
          --form email=jstephen@redhat.com \
          --form file=@build.tgz \
          --form version=master \
          --form description="PR code." \
          https://scan.coverity.com/builds?project=justin-stephenson%2Ftlog
